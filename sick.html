<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aboba</title>
    <style>
      label {
        display: block;
        cursor: pointer;
        width: 400px;
        height: 400px;
        background-size: cover;
        background-position: center;
        border: 2px dashed #ccc;
        margin: 20px 0;
      }
      #popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      #popupContent {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 80%;
        max-height: 80%;
        overflow: auto;
      }
      .image-thumbnail {
        width: 100px;
        height: 100px;
        margin: 5px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.3s ease, border-color 0.3s ease;
      }
      .image-thumbnail:hover {
        transform: scale(1.05);
        border-color: #ccc;
      }
      .popup-close {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 20px;
        color: white;
        cursor: pointer;
      }
      .dictionary-results {
        margin-top: 10px;
      }
      .result-item {
        background-color: #fafafa;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Test</h1>

    <label for="image" id="uploadLabel">
      <input type="file" name="image" id="image" style="display: none" />
    </label>

    <input type="text" id="searchInput" placeholder="Search for images or words" />

    <div id="popup">
      <div class="popup-close" onclick="closePopup()">X</div>
      <div id="popupContent"></div>
    </div>

    <button type="button" id="uploadButton">Upload</button>

    <div class="dictionary-results" id="results"></div>

    <script>
      const fileInput = document.getElementById("image");
      const uploadButton = document.getElementById("uploadButton");
      const label = document.querySelector("#uploadLabel");
      const popup = document.getElementById("popup");
      const popupContent = document.getElementById("popupContent");
      const searchInput = document.getElementById("searchInput");
      const resultsContainer = document.getElementById("results");
      let imageData = null; // Store the image file here

      window.addEventListener("paste", function (event) {
        const items = event.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.type.startsWith("image/")) {
            const file = item.getAsFile();
            imageData = file;
            const reader = new FileReader();
            reader.onload = function (e) {
              label.style.backgroundImage = `url(${e.target.result})`;
            };
            reader.readAsDataURL(file);
          }
        }
      });

      let debounceTimeout;
      searchInput.addEventListener("input", function () {
        const query = searchInput.value.trim();
        clearTimeout(debounceTimeout);
        if (query) {
          debounceTimeout = setTimeout(function () {
            searchImagesAndWords(query);
          }, 2000);
        } else {
          popup.style.display = "none";
          resultsContainer.innerHTML = "";
        }
      });

      async function searchImagesAndWords(query) {
        await searchImages(query);
        await fetchTranslations(query);
      }

      async function searchImages(query) {
        const accessKey = "flrfcq3Frm3NV2oS0KlGZ4FHCsTytmyFn9Ra1ZWEJBI";
        const url = `https://api.unsplash.com/search/photos?query=${query}&client_id=${accessKey}&per_page=12`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          displayImages(data.results);
        } catch (error) {
          console.error("Error fetching images:", error);
        }
      }

      function displayImages(images) {
        popupContent.innerHTML = "";
        if (images.length > 0) {
          images.forEach((image) => {
            const img = document.createElement("img");
            img.src = image.urls.thumb;
            img.alt = image.alt_description;
            img.classList.add("image-thumbnail");
            img.onclick = () => selectImage(image);
            popupContent.appendChild(img);
          });
          popup.style.display = "flex";
        }
      }

      function selectImage(image) {
        const imageUrl = image.urls.regular;
        label.style.backgroundImage = `url(${imageUrl})`;
        imageData = null;
        fetch(imageUrl)
          .then((response) => response.blob())
          .then((blob) => {
            const file = new File([blob], image.id + ".jpg", { type: "image/jpeg" });
            imageData = file;
          })
          .catch((error) => console.error("Error fetching image:", error));

        popup.style.display = "none";
      }

      function closePopup() {
        popup.style.display = "none";
      }

      fileInput.addEventListener("change", function () {
        const file = fileInput.files[0];
        if (file) {
          imageData = file;
          const reader = new FileReader();
          reader.onload = function (e) {
            label.style.backgroundImage = `url(${e.target.result})`;
          };
          reader.readAsDataURL(file);
        }
      });

      uploadButton.addEventListener("click", function () {
        if (!imageData) {
          alert("No image to upload.");
          return;
        }

        const formData = new FormData();
        formData.append("image", imageData);

        const mockCard = {
          id: Date.now(),
          Img: "path/to/uploaded/img.jpg", // Path will be set by the server
          item: "Sample text",
          itemReveal: "Revealed text",
          examples: [
            { item: "Example 1", itemReveal: "Example reveal 1" },
            { item: "Example 2", itemReveal: "Example reveal 2" },
          ],
          repeatNumber: 0,
          nextRepeat: Date.now(),
          metrika: {},
        };

        formData.append("card", JSON.stringify(mockCard));

        fetch("http://localhost:3000/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            console.log("File uploaded:", data);
          })
          .catch((error) => {
            console.error("Error uploading file:", error);
          });
      });

      const apiKey =
        "dict.1.1.20231123T220544Z.1f195b742ed11ead.0c3b1ec28970bbd60676daed6eb4836c8b7d4dcc";
      const langPair = "en-ru";

      function fetchTranslations(word) {
        const url = `https://dictionary.yandex.net/api/v1/dicservice.json/lookup?key=${apiKey}&lang=${langPair}&text=${word}`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            displayTranslations(data.def);
          })
          .catch((error) => {
            console.error("Error fetching translations:", error);
          });
      }

      function displayTranslations(definitions) {
        resultsContainer.innerHTML = "";
        if (definitions && definitions.length > 0) {
          definitions.forEach((def) => {
            const resultItem = document.createElement("div");
            resultItem.classList.add("result-item");
            resultItem.textContent = `${def.text} - ${def.tr.map((tr) => tr.text).join(", ")}`;
            resultsContainer.appendChild(resultItem);
          });
        } else {
          resultsContainer.innerHTML = "<p>No translations found</p>";
        }
      }
    </script>
  </body>
</html>
