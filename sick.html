<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Image from Clipboard</title>
    <style>
      label {
        display: block;
        cursor: pointer;
        width: 400px;
        height: 400px;
        background-size: cover;
        background-position: center;
        border: 2px dashed #ccc;
        margin: 20px 0;
      }
      #popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      #popupContent {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 80%;
        max-height: 80%;
        overflow: auto;
      }
      .image-thumbnail {
        width: 100px;
        height: 100px;
        margin: 5px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.3s ease, border-color 0.3s ease;
      }
      .image-thumbnail:hover {
        transform: scale(1.05);
        border-color: #ccc;
      }
      .popup-close {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 20px;
        color: white;
        cursor: pointer;
      }
      /* Styles for the dictionary search */
      .dictionary-results {
        margin-top: 10px;
      }
      .result-item {
        background-color: #fafafa;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Paste an Image or Upload from System</h1>

    <!-- Image Upload Label -->
    <label for="image" id="uploadLabel">
      <input type="file" name="image" id="image" style="display: none" />
    </label>

    <!-- Input for Searching Images and Words -->
    <input type="text" id="searchInput" placeholder="Search for images or words" />

    <!-- Popup for Image Selection -->
    <div id="popup">
      <div class="popup-close" onclick="closePopup()">X</div>
      <div id="popupContent"></div>
    </div>

    <button type="button" id="uploadButton">Upload</button>

    <!-- Dictionary Search Results -->
    <div class="dictionary-results" id="results"></div>

    <script>
      const fileInput = document.getElementById("image");
      const uploadButton = document.getElementById("uploadButton");
      const label = document.querySelector("#uploadLabel");
      const popup = document.getElementById("popup");
      const popupContent = document.getElementById("popupContent");
      const searchInput = document.getElementById("searchInput");
      const resultsContainer = document.getElementById("results");
      let imageData = null; // Store the image file here
      let selectedImage = null; // Store the selected image for upload

      // Listen for the paste event to handle image pasting
      window.addEventListener("paste", function (event) {
        const items = event.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
          const item = items[i];

          if (item.type.startsWith("image/")) {
            const file = item.getAsFile();
            imageData = file;

            const reader = new FileReader();
            reader.onload = function (e) {
              label.style.backgroundImage = `url(${e.target.result})`;
            };
            reader.readAsDataURL(file);
          }
        }
      });

      let debounceTimeout; // Declare a variable to hold the timeout ID

      // Handle search input (both for images and words)
      searchInput.addEventListener("input", function () {
        const query = searchInput.value.trim();

        // Clear the previous timeout to reset the delay whenever the user types
        clearTimeout(debounceTimeout);

        if (query) {
          // Set a new timeout to trigger the search after 2 seconds of inactivity
          debounceTimeout = setTimeout(function () {
            searchImagesAndWords(query); // Call the search function after 2 seconds
          }, 2000);
        } else {
          popup.style.display = "none"; // Hide popup if the query is empty
          resultsContainer.innerHTML = ""; // Clear previous dictionary results
        }
      });

      // Search both images and words (translations) from the input query
      async function searchImagesAndWords(query) {
        // Search for images first
        await searchImages(query);

        // Then, search for word translations
        await fetchTranslations(query);
      }

      // Search images from Unsplash API
      async function searchImages(query) {
        const accessKey = "flrfcq3Frm3NV2oS0KlGZ4FHCsTytmyFn9Ra1ZWEJBI"; // Unsplash Access Key
        const url = `https://api.unsplash.com/search/photos?query=${query}&client_id=${accessKey}&per_page=12`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          displayImages(data.results);
        } catch (error) {
          console.error("Error fetching images:", error);
        }
      }

      // Display images in the popup
      function displayImages(images) {
        popupContent.innerHTML = ""; // Clear previous images

        if (images.length > 0) {
          images.forEach((image) => {
            const img = document.createElement("img");
            img.src = image.urls.thumb;
            img.alt = image.alt_description;
            img.classList.add("image-thumbnail");
            img.onclick = () => selectImage(image);

            popupContent.appendChild(img);
          });

          popup.style.display = "flex";
        }
      }

      // Select an image and close the popup
      function selectImage(image) {
        selectedImage = image; // Store selected image

        // Get the image URL for display (from Unsplash API)
        const imageUrl = image.urls.regular;

        // Set the background of the label to the selected image
        label.style.backgroundImage = `url(${imageUrl})`;

        // Store the image data URL for upload (we need to download the image)
        imageData = null; // Clear any existing image data

        // Fetch the image as a Blob and store it in imageData
        fetch(imageUrl)
          .then((response) => response.blob())
          .then((blob) => {
            const file = new File([blob], image.id + ".jpg", { type: "image/jpeg" });
            console.log(file);
            imageData = file; // Now we have a valid File object for upload
          })
          .catch((error) => console.error("Error fetching image:", error));

        // Close the popup
        popup.style.display = "none";
      }

      // Close the popup
      function closePopup() {
        popup.style.display = "none";
      }

      // Handle the file upload from the system
      fileInput.addEventListener("change", function () {
        const file = fileInput.files[0];
        if (file) {
          imageData = file;

          const reader = new FileReader();
          reader.onload = function (e) {
            label.style.backgroundImage = `url(${e.target.result})`;
          };
          reader.readAsDataURL(file);
        }
      });

      // Handle the upload button click
      uploadButton.addEventListener("click", function () {
        // Ensure imageData is not null before uploading
        if (!imageData) {
          alert("No image to upload.");
          return;
        }

        const formData = new FormData();
        formData.append("image", imageData);

        fetch("http://localhost:3000/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            console.log("File uploaded:", data);
          })
          .catch((error) => {
            console.error("Error uploading file:", error);
          });
      });

      // API key for Yandex Dictionary
      const apiKey =
        "dict.1.1.20231123T220544Z.1f195b742ed11ead.0c3b1ec28970bbd60676daed6eb4836c8b7d4dcc";
      const langPair = "en-ru";

      // Fetch word translations from Yandex API
      function fetchTranslations(word) {
        const url = `https://dictionary.yandex.net/api/v1/dicservice.json/lookup?key=${apiKey}&lang=${langPair}&text=${word}`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            displayTranslations(data.def);
          })
          .catch((error) => {
            console.error;
            console.error("Error fetching translations:", error);
          });
      }

      // Display translation results in the dictionary results container
      function displayTranslations(definitions) {
        // Clear previous results
        resultsContainer.innerHTML = "";

        if (definitions && definitions.length > 0) {
          definitions.forEach((def) => {
            const resultItem = document.createElement("div");
            resultItem.classList.add("result-item");
            resultItem.innerHTML = `
              <strong>${def.text}</strong> - ${def.pos}<br>
              ${def.tr.map((translation) => translation.text).join(", ")}
            `;
            resultsContainer.appendChild(resultItem);
          });
        } else {
          resultsContainer.innerHTML = "<p>No definitions found.</p>";
        }
      }
    </script>
  </body>
</html>
